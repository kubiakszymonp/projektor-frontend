<!DOCTYPE html>
<html>

<head>
    <title>WebRTC Test</title>
</head>

<body>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <script>
        async function startWebRTC() {
            const localStream = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById('localVideo').srcObject = localStream;

            const peerConnection1 = new RTCPeerConnection();
            const peerConnection2 = new RTCPeerConnection();

            document.getElementById('localVideo').srcObject.getTracks().forEach(track => peerConnection1.addTrack(track, document.getElementById('localVideo').srcObject));

            peerConnection1.onicegatheringstatechange = async (event) => {
                if (peerConnection1.iceGatheringState === 'complete') {
                    console.log('peerConnection1 ICE candidates: ', peerConnection1.localDescription);
                    await peerConnection2.setRemoteDescription(peerConnection1.localDescription);
                    const answer = await peerConnection2.createAnswer();
                    await peerConnection2.setLocalDescription(answer);
                }
            }

            peerConnection2.onicegatheringstatechange = async (event) => {
                if (peerConnection1.iceGatheringState === 'complete') {
                    console.log('peerConnection2 ICE state: ', peerConnection2.iceConnectionState);
                    await peerConnection1.setRemoteDescription(peerConnection2.localDescription);
                }
            };

            peerConnection2.ontrack = (event) => {
                console.log('peerConnection2 received remote stream');
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            const offer = await peerConnection1.createOffer();
            await peerConnection1.setLocalDescription(offer);

            peerConnection1.onconnectionstatechange = (event) => {
                console.log('peerConnection1 connection state: ', peerConnection1.connectionState);
            };

            peerConnection2.onconnectionstatechange = (event) => {
                console.log('peerConnection2 connection state: ', peerConnection2.connectionState);
            };

        }

        startWebRTC();
    </script>
</body>

</html>